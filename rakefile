require 'rubygems'
require 'tmpdir'
require 'bundler/setup'
require 'jekyll'

GITHUB_REPONAME = 'lyc4n/lyc4n.github.io'

desc "Creates a new article with current date and open in vim(Eg: rake new_artitle Forbidden Code)"
task :new_article do
  dir = "_posts"

  original_title = (ARGV[1..-1].join(" ") || "Untitled").strip
  title = original_title.downcase.gsub(" ", "-")
  title = "#{Time.now.strftime('%Y-%m-%d')}-#{title}.md"

  post_path = "./#{dir}/#{title}"
  File.open post_path, "w"  do |post|
    post.puts("---")
    post.puts("layout: post")
    post.puts("title: #{original_title}")
    post.puts("---")
  end

  puts "Opening #{post_path}"
  system('vim', post_path)
end

namespace :site do
  desc 'Generate blog files'
  task :generate do
    system 'rm -rf ./_production_site'
    ENV['JEKYLL_ENV'] = 'production'
    Jekyll::Site.new(Jekyll.configuration({
      'source'      => '.',
      'destination' => '_production_site'
    })).process
  end

  desc 'Generate and publish blog to gh-pages'
  task :publish => [:generate] do
    Dir.mktmpdir do |tmp|
      cp_r '_production_site/.', tmp

      pwd = Dir.pwd
      Dir.chdir tmp

      system 'git init'
      system 'git add .'
      message = "Site updated at #{Time.now.utc}"
      system "git commit -m #{message.inspect}"
      system "git remote add origin git@github.com:#{GITHUB_REPONAME}.git"
      system 'git push origin master --force'

      Dir.chdir pwd
    end
  end
end
